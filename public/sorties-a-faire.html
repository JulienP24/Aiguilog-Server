<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aiguilog - Sorties √† faire</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h2>Sorties √† faire</h2>

    <button id="logout-btn" style="float:right; margin-bottom:1rem;">Se d√©connecter</button>

    <form id="add-sortie-form" autocomplete="off">
      <input type="text" name="sommet" placeholder="Sommet" required />
      <input type="number" name="altitude" placeholder="Altitude (m)" required />
      <input type="number" name="denivele" placeholder="D√©nivel√© (m)" required />
      <select name="methode" required>
        <option value="" disabled selected>M√©thode</option>
        <option value="Alpinisme">Alpinisme</option>
        <option value="Randonn√©e">Randonn√©e</option>
        <option value="Escalade">Escalade</option>
      </select>
      <input type="text" name="cotation" placeholder="Cotation (facultatif)" />
      <textarea name="details" placeholder="D√©tails (facultatif)" rows="2"></textarea>
      <button type="submit">Ajouter</button>
    </form>

    <div class="table-container">
      <table id="sorties-table">
        <thead>
          <tr>
            <th>Sommet</th>
            <th>Altitude (m)</th>
            <th>D√©nivel√© (m)</th>
            <th>M√©thode</th>
            <th>Cotation</th>
            <th>D√©tails</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

<script>
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = 'index.html';
  }

  const tableBody = document.querySelector('#sorties-table tbody');
  const form = document.getElementById('add-sortie-form');
  const logoutBtn = document.getElementById('logout-btn');

  logoutBtn.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });

  async function fetchSorties() {
    const res = await fetch('/api/sorties?done=false', {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) {
      alert('Erreur r√©cup√©ration sorties');
      return;
    }
    const sorties = await res.json();
    tableBody.innerHTML = '';

    sorties.forEach(s => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.sommet}</td>
        <td>${s.altitude}</td>
        <td>${s.denivele}</td>
        <td>${s.methode}</td>
        <td>${s.cotation || ''}</td>
        <td>${s.details || ''}</td>
        <td>
          <button data-id="${s._id}" class="delete-btn">üóëÔ∏è</button>
          <button data-id="${s._id}" class="done-btn">‚úîÔ∏è</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const formData = new FormData(form);
    const sortieData = {
      sommet: formData.get('sommet').trim(),
      altitude: Number(formData.get('altitude')),
      denivele: Number(formData.get('denivele')),
      methode: formData.get('methode'),
      cotation: formData.get('cotation').trim() || '',
      details: formData.get('details').trim() || '',
      done: false
    };

    const res = await fetch('/api/sorties', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify(sortieData),
    });
    if (!res.ok) {
      alert('Erreur ajout sortie');
      return;
    }
    form.reset();
    fetchSorties();
  });

  tableBody.addEventListener('click', async e => {
    if (e.target.classList.contains('delete-btn')) {
      const id = e.target.dataset.id;
      if (!confirm('Supprimer cette sortie ?')) return;

      const res = await fetch(`/api/sorties/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) {
        alert('Erreur suppression');
        return;
      }
      fetchSorties();
    } else if (e.target.classList.contains('done-btn')) {
      const id = e.target.dataset.id;

      // Mettre √† jour sortie : done = true + date = aujourd'hui
      const res = await fetch(`/api/sorties/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
        body: JSON.stringify({ done: true, date: new Date().toISOString() }),
      });
      if (!res.ok) {
        alert('Erreur mise √† jour');
        return;
      }
      fetchSorties();
    }
  });

  fetchSorties();
</script>
</body>
</html>
