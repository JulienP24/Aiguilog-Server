<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aiguilog - Sorties faites</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h2>Sorties faites</h2>

    <button id="logout-btn" style="float:right; margin-bottom:1rem;">Se d√©connecter</button>

    <div class="table-container">
      <table id="sorties-faites-table">
        <thead>
          <tr>
            <th>Sommet</th>
            <th>Altitude (m)</th>
            <th>D√©nivel√© (m)</th>
            <th>M√©thode</th>
            <th>Cotation</th>
            <th>Date</th>
            <th>D√©tails</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

<script>
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = 'index.html';
  }

  const tableBody = document.querySelector('#sorties-faites-table tbody');
  const logoutBtn = document.getElementById('logout-btn');

  logoutBtn.addEventListener('click', () => {
    localStorage.clear();
    window.location.href = 'index.html';
  });

  async function fetchSorties() {
    const res = await fetch('/api/sorties?done=true', {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!res.ok) {
      alert('Erreur r√©cup√©ration sorties');
      return;
    }
    const sorties = await res.json();
    tableBody.innerHTML = '';

    sorties.forEach(s => {
      const dateFormatted = s.date ? new Date(s.date).toLocaleDateString('fr-FR') : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.sommet}</td>
        <td>${s.altitude}</td>
        <td>${s.denivele}</td>
        <td>${s.methode}</td>
        <td>${s.cotation || ''}</td>
        <td>${dateFormatted}</td>
        <td>${s.details || ''}</td>
        <td>
          <button data-id="${s._id}" class="delete-btn">üóëÔ∏è</button>
          <button data-id="${s._id}" class="edit-btn">‚úèÔ∏è</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  // Suppression sortie
  tableBody.addEventListener('click', async e => {
    if (e.target.classList.contains('delete-btn')) {
      const id = e.target.dataset.id;
      if (!confirm('Supprimer cette sortie ?')) return;

      const res = await fetch(`/api/sorties/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) {
        alert('Erreur suppression');
        return;
      }
      fetchSorties();
    } else if (e.target.classList.contains('edit-btn')) {
      const id = e.target.dataset.id;
      const row = e.target.closest('tr');

      // On cr√©e un formulaire inline pour √©diter
      if (row.querySelector('input')) return; // d√©j√† en √©dition

      const cells = row.querySelectorAll('td');
      const sommet = cells[0].textContent;
      const altitude = cells[1].textContent;
      const denivele = cells[2].textContent;
      const methode = cells[3].textContent;
      const cotation = cells[4].textContent;
      const date = cells[5].textContent;
      const details = cells[6].textContent;

      cells[0].innerHTML = `<input type="text" value="${sommet}" />`;
      cells[1].innerHTML = `<input type="number" value="${altitude}" />`;
      cells[2].innerHTML = `<input type="number" value="${denivele}" />`;
      cells[3].innerHTML = `
        <select>
          <option value="Alpinisme" ${methode === 'Alpinisme' ? 'selected' : ''}>Alpinisme</option>
          <option value="Randonn√©e" ${methode === 'Randonn√©e' ? 'selected' : ''}>Randonn√©e</option>
          <option value="Escalade" ${methode === 'Escalade' ? 'selected' : ''}>Escalade</option>
        </select>
      `;
      cells[4].innerHTML = `<input type="text" value="${cotation}" />`;
      cells[5].innerHTML = `<input type="date" value="${date ? new Date(date.split('/').reverse().join('-')).toISOString().slice(0,10) : ''}" />`;
      cells[6].innerHTML = `<input type="text" value="${details}" />`;
      cells[7].innerHTML = `
        <button class="save-btn" data-id="${id}">üíæ</button>
        <button class="cancel-btn">‚ùå</button>
      `;
    } else if (e.target.classList.contains('cancel-btn')) {
      fetchSorties(); // Reload pour annuler √©dition
    } else if (e.target.classList.contains('save-btn')) {
      const id = e.target.dataset.id;
      const row = e.target.closest('tr');
      const inputs = row.querySelectorAll('input, select');

      const updatedSortie = {
        sommet: inputs[0].value.trim(),
        altitude: Number(inputs[1].value),
        denivele: Number(inputs[2].value),
        methode: inputs[3].value,
        cotation: inputs[4].value.trim(),
        date: inputs[5].value ? new Date(inputs[5].value).toISOString() : null,
        details: inputs[6].value.trim(),
      };

      try {
        const res = await fetch(`/api/sorties/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify(updatedSortie),
        });
        if (!res.ok) throw new Error('Erreur mise √† jour');
        fetchSorties();
      } catch {
        alert('Erreur mise √† jour');
      }
    }
  });

  fetchSorties();
</script>
</body>
</html>
